# Story 1.2: User Profile Management

## Status
Approved for Developing

## Story
**As a** médico usuário autenticado,
**I want** gerenciar meus dados profissionais e pessoais no sistema,
**so that** posso manter minhas informações atualizadas e ter controle sobre meu perfil médico.

## Acceptance Criteria
1. Sistema deve permitir visualização dos dados do perfil após autenticação
2. Usuário deve poder editar dados pessoais (nome, telefone)
3. Usuário deve poder editar dados profissionais (CRM, especialidade)
4. Sistema deve validar formato do CRM conforme padrões brasileiros
5. Alterações devem ser persistidas no banco de dados
6. Interface deve fornecer feedback visual para operações de salvamento
7. Sistema deve permitir upload e gerenciamento de foto de perfil (opcional)
8. Dados devem ser sincronizados com as informações de autenticação do Supabase

## Tasks / Subtasks
- [ ] Implementar UserProfileManager component (AC: 1, 2, 3, 5, 6)
  - [ ] Criar components/auth/user-profile-manager.tsx
  - [ ] Implementar useProfileManager hook com CRUD operations
  - [ ] Adicionar React Hook Form para gerenciamento de estado do formulário
  - [ ] Implementar validation schemas com Zod para dados pessoais e profissionais
- [ ] Implementar validação de CRM brasileiros (AC: 4)
  - [ ] Criar função validateCRM em lib/utils.ts para formatos CRM/UF
  - [ ] Integrar validação no formulário de perfil
  - [ ] Adicionar feedback visual para CRM inválidos
- [ ] Criar API endpoint para profile management (AC: 5, 8)
  - [ ] Implementar GET /api/profile para buscar dados do perfil
  - [ ] Enhancear PUT /api/profile com validação completa
  - [ ] Adicionar middleware de autenticação JWT
  - [ ] Implementar sincronização com auth.users table
- [ ] Implementar avatar upload functionality (AC: 7)
  - [ ] Configurar Supabase Storage bucket para avatars
  - [ ] Criar upload component com preview e cropping
  - [ ] Adicionar DELETE /api/profile/avatar endpoint
  - [ ] Implementar size e format validation para imagens
- [ ] Integrar com AuthenticationProvider (AC: 8)
  - [ ] Adicionar profile data ao useAuth context
  - [ ] Implementar profile refresh após updates
  - [ ] Sincronizar email changes com Supabase Auth
- [ ] Implementar testes para profile management (AC: 1-8)
  - [ ] Unit tests para UserProfileManager component
  - [ ] Integration tests para API endpoints /api/profile
  - [ ] Validation tests para CRM e dados profissionais
  - [ ] E2E tests para fluxo completo de edição de perfil

## Dev Notes

### Previous Story Insights
Story 1.1 estabeleceu AuthenticationProvider e estrutura Supabase. Esta story constrói sobre essa fundação, focando em gerenciamento de dados do usuário já autenticado.

### Technical Context from Architecture
[Source: docs/architecture.md#component-architecture]

**UserProfileManager Component:**
- Responsibility: Gerenciar dados do perfil profissional do médico
- Integration Points: Integra com AuthScreen existente para coleta e validação de dados profissionais
- Key Interfaces: createProfile(profileData), updateProfile(profileData), validateCRM(crm)
- Dependencies: Uses AuthenticationProvider and AssessmentPersistenceService

### Data Models
[Source: docs/architecture.md#data-models-and-schema-changes]

**Profile Model Schema:**
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  crm TEXT NOT NULL,
  specialty TEXT NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Key Attributes:**
- `id: UUID` - Chave primária referenciando auth.users(id)  
- `name: TEXT NOT NULL` - Nome completo do médico
- `email: TEXT NOT NULL` - Email profissional (sincronizado com auth)
- `phone: TEXT` - Telefone de contato
- `crm: TEXT NOT NULL` - Registro profissional obrigatório
- `specialty: TEXT NOT NULL` - Especialidade médica
- `avatar_url: TEXT` - URL opcional para foto de perfil

### API Specifications
[Source: docs/architecture.md#api-design-and-integration]

**PUT /api/profile endpoint:**
- Purpose: Atualizar dados do perfil profissional do médico
- Integration: Usado pelo UserProfileManager para atualizações
- Request Format:
```json
{
  "name": "Dr. João Silva",
  "phone": "+5511999999999", 
  "crm": "CRM/SP 123456",
  "specialty": "Cardiologia"
}
```
- Response Format:
```json
{
  "status": "success",
  "message": "Profile updated successfully",
  "profile": { "id": "uuid", "name": "Dr. João Silva" }
}
```

### File Locations
[Source: docs/architecture.md#new-file-organization]

**New files to create:**
- `components/auth/user-profile-manager.tsx` - Main profile management component
- `components/auth/avatar-upload.tsx` - Avatar upload and management component  
- `lib/services/profile-service.ts` - Profile data service layer
- `app/api/profile/route.ts` - Profile CRUD API endpoint
- `app/api/profile/avatar/route.ts` - Avatar upload/delete endpoint

**Files to enhance:**
- `components/providers/auth-provider.tsx` - Add profile data to auth context
- `lib/utils.ts` - Add CRM validation utilities

### Technical Constraints  
[Source: docs/architecture.md#coding-standards-and-conventions]

- **Supabase Client Usage:** Server client for API routes, browser client for components only
- **Error Handling:** try/catch patterns with structured logging for Supabase operations
- **Type Safety:** TypeScript interfaces for all profile data models
- **Authentication Flow:** JWT session verification required for all profile operations
- **File Organization:** Follow app/api/ structure for RESTful endpoints

### Integration Requirements
[Source: docs/architecture.md#enhancement-scope-and-integration-strategy]

- **Existing Component Integration:** Maintain compatibility with AuthScreen component interface
- **State Management:** Integrate profile data into AuthenticationProvider context
- **UI Consistency:** Preserve Radix UI + Tailwind CSS design system
- **Performance:** Minimize API calls, implement client-side caching for profile data

### Security Requirements
[Source: docs/architecture.md#security-integration]

- **Authentication:** JWT token validation for all profile API endpoints
- **Authorization:** Row Level Security policies ensuring users can only access their own profile
- **Data Validation:** Zod schemas for input validation on both client and server
- **File Upload Security:** Size limits, format validation, and secure storage for avatars

## Testing

### Testing Standards
[Source: docs/architecture.md#testing-strategy]

**Framework:** Jest + React Testing Library (padrão Next.js)
**Location:** __tests__ folders co-localizados com components
**Coverage Target:** 80% para UserProfileManager, profile API routes

**Required Tests:**
- Unit tests para UserProfileManager component e hooks
- Integration tests para API endpoints GET/PUT /api/profile  
- Validation tests para CRM format validation
- E2E tests para fluxo completo de edit profile
- Security tests para authorization (users can only edit their own profile)

**Test Commands:** Use existing Jest configuration from story 1.1