# Story 1.8: Build Infrastructure and UI Organization Fixes

**Criado em:** 27 de Janeiro de 2025  
**Product Owner:** Sarah ğŸ“  
**Baseado em:** AnÃ¡lise de CorreÃ§Ã£o de Curso QA Stories 1.6-1.7  
**Prioridade:** P0 - BLOQUEADOR DE PRODUÃ‡ÃƒO CRÃTICO  

---

## ğŸ“Š Status

**Status Atual:** Aproved  
**Epic:** 1.0 - Authentication and Persistence Foundation  
**Estimativa:** 16-23 horas de desenvolvimento (Sprint Emergencial)  
**Assignee:** TBD  

---

## ğŸ“– Story

**As a** desenvolvedor e Product Owner,  
**I want** consolidar a infraestrutura de build e organizar componentes UI duplicados,  
**so that** possamos ter um sistema estruturalmente sÃ³lido, sem conflitos de build, e preparado para deploy seguro em produÃ§Ã£o.

---

## âœ… Acceptance Criteria

### Structural Requirements

**AC 1: ConsolidaÃ§Ã£o de Componentes UI**
- Eliminar duplicaÃ§Ã£o total entre `/ui/` e `/components/ui/`
- Migrar todos imports para usar APENAS `@/components/ui`
- Validar que todos os 47+ arquivos usam imports corretos
- Remover diretÃ³rio `/ui/` legado completamente

**AC 2: ReorganizaÃ§Ã£o de Arquivos da Raiz**
- Mover todos `*.tsx` da raiz para `/components/`
- Mover todos `use-*.ts` da raiz para `/hooks/`
- Mover `utils.ts` da raiz para `/lib/`
- Atualizar todos imports afetados pelos movimentos

**AC 3: CorreÃ§Ã£o de ConfiguraÃ§Ã£o de Build**
- Ativar validaÃ§Ã£o TypeScript no build (`ignoreBuildErrors: false`)
- Ativar validaÃ§Ã£o ESLint no build (`ignoreDuringBuilds: false`)
- Corrigir todos erros TypeScript/ESLint expostos
- Build deve passar sem warnings crÃ­ticos

### Quality Requirements

**AC 4: Infraestrutura de Testes Corrigida**
- Corrigir mocking problemÃ¡tico do NextRequest
- Implementar fetch mocking adequado para APIs
- Resolver problemas de setup de DOM identificados no QA
- Atingir 80% cobertura mÃ­nima nos componentes crÃ­ticos

**AC 5: Sistema Existente Intacto**
- Funcionalidade de avaliaÃ§Ã£o continua operacional
- Design system mantido consistente
- Performance sem degradaÃ§Ã£o
- NavegaÃ§Ã£o e UX preservadas

### Technical Requirements

**AC 6: Quality Gates Implementados**
- Pre-commit hooks para validaÃ§Ã£o
- Coverage gates no CI/CD pipeline
- Lint-staged para verificaÃ§Ã£o automÃ¡tica
- Build pipeline robusto sem bypass de erros

---

## ğŸ“‹ Tasks / Subtasks

### ğŸ”´ Priority 1: ConsolidaÃ§Ã£o UI (AC 1)

- [ ] **Task 1: AnÃ¡lise e Mapeamento de DuplicaÃ§Ãµes** (AC 1)
  - [ ] Executar audit completo de imports `@/ui` vs `@/components/ui`
  - [ ] Mapear todos os arquivos afetados pelos imports duplicados
  - [ ] Identificar diferenÃ§as entre versÃµes duplicadas de componentes
  - [ ] Criar plano de migraÃ§Ã£o segura

- [ ] **Task 2: MigraÃ§Ã£o Segura de Imports** (AC 1)
  - [ ] Atualizar imports em `components/assessment/assessment-history.tsx`
  - [ ] Atualizar imports em `components/assessment/assessment-detail-view.tsx`
  - [ ] Atualizar imports em `components/completion-screen.tsx`
  - [ ] Atualizar imports em `components/auth-screen.tsx`
  - [ ] Atualizar imports em `components/assessment/results-viewer.tsx`
  - [ ] Atualizar imports em `components/soft-skills-screen.tsx`
  - [ ] Atualizar imports em `components/sjt-screen.tsx`
  - [ ] Atualizar imports em `components/assessment/resume-assessment-modal.tsx`
  - [ ] Atualizar imports em `components/mini-disc-screen.tsx`
  - [ ] Validar build apÃ³s cada bloco de mudanÃ§as

- [ ] **Task 3: RemoÃ§Ã£o do DiretÃ³rio Legado** (AC 1)
  - [ ] Backup do diretÃ³rio `/ui/` para seguranÃ§a
  - [ ] Validar que todos imports foram migrados
  - [ ] Remover diretÃ³rio `/ui/` completamente
  - [ ] Testar build completo sem erros

### ğŸŸ¡ Priority 2: ReorganizaÃ§Ã£o de Arquivos (AC 2)

- [ ] **Task 4: MovimentaÃ§Ã£o de Screens para Components** (AC 2)
  - [ ] Mover `auth-screen.tsx` para `components/auth-screen.tsx`
  - [ ] Mover `completion-screen.tsx` para `components/completion-screen.tsx`
  - [ ] Mover `mini-disc-screen.tsx` para `components/mini-disc-screen.tsx`
  - [ ] Mover `sjt-screen.tsx` para `components/sjt-screen.tsx`
  - [ ] Mover `soft-skills-screen.tsx` para `components/soft-skills-screen.tsx`
  - [ ] Mover demais arquivos `*-screen.tsx` para `components/`
  - [ ] Atualizar imports em `app/page.tsx` e outros arquivos afetados

- [ ] **Task 5: MovimentaÃ§Ã£o de Hooks e Utils** (AC 2)
  - [ ] Mover `use-mobile.ts` para `hooks/use-mobile.ts`
  - [ ] Mover `use-toast.ts` para `hooks/use-toast.ts`
  - [ ] Mover `utils.ts` para `lib/utils.ts` (consolidar com existente)
  - [ ] Atualizar todos imports afetados
  - [ ] Resolver conflitos de naming se existirem

### ğŸŸ  Priority 3: CorreÃ§Ã£o de Build (AC 3)

- [ ] **Task 6: AtivaÃ§Ã£o de ValidaÃ§Ãµes** (AC 3)
  - [ ] Modificar `next.config.mjs` para ativar validaÃ§Ãµes
  - [ ] Executar build e documentar todos erros expostos
  - [ ] Corrigir erros TypeScript identificados
  - [ ] Corrigir warnings ESLint crÃ­ticos
  - [ ] Validar build limpo sem bypass

### ğŸŸ¢ Priority 4: CorreÃ§Ã£o de Testes (AC 4)

- [ ] **Task 7: Infraestrutura de Testes** (AC 4)
  - [ ] Corrigir setup de mock do NextRequest no `jest.setup.js`
  - [ ] Implementar fetch mocking adequado para testes de API
  - [ ] Resolver problemas de DOM rendering nos testes
  - [ ] Estabilizar testes instÃ¡veis identificados no QA Report

- [ ] **Task 8: Atingir Coverage MÃ­nimo** (AC 4)
  - [ ] Executar coverage report atual
  - [ ] Identificar gaps crÃ­ticos abaixo de 80%
  - [ ] Implementar testes especÃ­ficos para gaps identificados
  - [ ] Validar 80%+ coverage nos componentes crÃ­ticos

### ğŸŸ¦ Priority 5: Quality Gates (AC 6)

- [ ] **Task 9: ImplementaÃ§Ã£o de Quality Gates** (AC 6)
  - [ ] Configurar pre-commit hooks com husky
  - [ ] Implementar lint-staged para validaÃ§Ã£o automÃ¡tica
  - [ ] Configurar coverage gates no package.json
  - [ ] Testar pipeline completo de QA

---

## ğŸ› ï¸ Dev Notes

### Previous Story Insights
[Source: docs/qa-report-story-1.6-2025-01-27.md, docs/stories/1.7.testing-implementation-suite.md]

**From QA Report - Story 1.7 Critical Issues:**
- âŒ **NextRequest Mocking**: jest.setup.js tem classe MockRequest que conflita com NextRequest do Next.js
- âŒ **Hook Implementation**: useAssessmentHistory nÃ£o implementa corretamente filtros em query params  
- âŒ **Component State**: AssessmentHistory nÃ£o limpa estado de erro adequadamente
- âŒ **API Integration**: Testes de API nÃ£o executam pela configuraÃ§Ã£o incorreta de mocks
- âŒ **Test Coverage**: Muito abaixo dos 80% requeridos (atual ~47% nos componentes crÃ­ticos)

**Critical Structural Problems Identified:**
- ğŸš¨ **UI Components DUPLICATED**: Duas estruturas completas (`/ui/` e `/components/ui/`)
- ğŸš¨ **Build Config Masking Errors**: `ignoreBuildErrors: true` e `ignoreDuringBuilds: true`
- ğŸš¨ **File Organization**: 10+ arquivos importantes na raiz do projeto

### Technical Context from Architecture
[Source: docs/architecture.md#component-architecture, docs/coding-standards.md]

**Project Structure Standards:**
```
/
â”œâ”€â”€ app/                    # Next.js App Router
â”œâ”€â”€ components/            # React Components
â”‚   â”œâ”€â”€ __tests__/         # Component tests
â”‚   â”œâ”€â”€ providers/         # Context Providers  
â”‚   â”œâ”€â”€ auth/             # Auth components
â”‚   â””â”€â”€ ui/               # UI Components (shadcn/ui) - ÃšNICO
â”œâ”€â”€ hooks/                # Custom React Hooks
â”œâ”€â”€ lib/                  # Libraries and utilities
â”‚   â”œâ”€â”€ supabase/         # Supabase config
â”‚   â””â”€â”€ utils.ts          # Utility functions - ÃšNICO
```

**File Naming Conventions:**
- **Components**: `kebab-case.tsx` (ex: `auth-screen.tsx`)
- **Hooks**: `use-nome-do-hook.ts` (ex: `use-mobile.ts`)
- **Utils**: `kebab-case.ts` (ex: `utils.ts`)

**Build Configuration Standards:**
```javascript
// next.config.mjs - REQUIRED SETTINGS:
eslint: {
  ignoreDuringBuilds: false,  // âœ… ENABLE VALIDATION
},
typescript: {
  ignoreBuildErrors: false,   // âœ… ENABLE VALIDATION
}
```

### Component Location Mapping
[Source: Project file structure analysis]

**Files to Move - Current Location â†’ Target Location:**
```
ğŸ“ ROOT â†’ components/:
â”œâ”€â”€ auth-screen.tsx â†’ components/auth-screen.tsx
â”œâ”€â”€ completion-screen.tsx â†’ components/completion-screen.tsx
â”œâ”€â”€ mini-disc-screen.tsx â†’ components/mini-disc-screen.tsx
â”œâ”€â”€ sjt-screen.tsx â†’ components/sjt-screen.tsx
â”œâ”€â”€ soft-skills-screen.tsx â†’ components/soft-skills-screen.tsx
â”œâ”€â”€ detailed-report-screen.tsx â†’ components/detailed-report-screen.tsx
â”œâ”€â”€ final-report-screen.tsx â†’ components/final-report-screen.tsx
â”œâ”€â”€ result-screen.tsx â†’ components/result-screen.tsx
â”œâ”€â”€ assessment-screen.tsx â†’ components/assessment-screen.tsx
â”œâ”€â”€ theme-provider.tsx â†’ components/theme-provider.tsx
â””â”€â”€ ai-chat-widget.tsx â†’ components/ai-chat-widget.tsx

ğŸ“ ROOT â†’ hooks/:
â”œâ”€â”€ use-mobile.ts â†’ hooks/use-mobile.ts
â””â”€â”€ use-toast.ts â†’ hooks/use-toast.ts

ğŸ“ ROOT â†’ lib/:
â””â”€â”€ utils.ts â†’ lib/utils.ts (merge with existing)
```

**UI Duplicates to Remove:**
```
ğŸ“ /ui/ (REMOVE ENTIRE DIRECTORY):
â”œâ”€â”€ accordion.tsx          # DUPLICATE of components/ui/accordion.tsx
â”œâ”€â”€ alert-dialog.tsx       # DUPLICATE of components/ui/alert-dialog.tsx
â”œâ”€â”€ button.tsx             # DUPLICATE of components/ui/button.tsx
â”œâ”€â”€ card.tsx               # DUPLICATE of components/ui/card.tsx
â”œâ”€â”€ input.tsx              # DUPLICATE of components/ui/input.tsx
â””â”€â”€ [... 40+ other duplicated components]
```

### Testing Infrastructure Context
[Source: jest.config.js, docs/stories/1.7.testing-implementation-suite.md]

**Current Testing Setup:**
- Framework: Jest + @testing-library/react + @testing-library/jest-dom
- Config: jest.config.js with 85% coverage thresholds
- Pattern: Tests in `__tests__/` directories

**Issues to Fix:**
```javascript
// jest.setup.js - PROBLEMA CRÃTICO:
class MockRequest {
  // Conflita com NextRequest do Next.js
}

// SOLUÃ‡ÃƒO NECESSÃRIA:
// Implementar mocking adequado do fetch API
global.fetch = jest.fn()
```

**Coverage Targets:**
- Global: 85% (branches, functions, lines, statements)
- assessment-service.ts: 90%
- use-assessment-autosave.ts: 85%

### Testing

**Test File Locations:**
- Component tests: `components/**/__tests__/[component-name].test.tsx`
- Hook tests: `hooks/__tests__/[hook-name].test.ts`
- API tests: `app/api/**/__tests__/route.test.ts`

**Testing Frameworks and Patterns:**
- Use Jest + @testing-library/react for components
- Use @testing-library/jest-dom for DOM assertions
- Mock API calls using Jest mocks
- Follow existing patterns in codebase for consistency

**Specific Testing Requirements:**
- 80% minimum code coverage (architectural standard)
- Test all user interactions (clicks, input, navigation)
- Test loading states, error states, and empty states
- Test file organization after moves (imports work correctly)
- Mock external dependencies (APIs, file operations)

**Mock Strategies:**
```typescript
// File Import Testing Pattern
// After moving files, test imports work:
import { Button } from '@/components/ui/button'  // Should work
import AuthScreen from '@/components/auth-screen'  // Should work after move

// API Mocking Pattern - FIXED
global.fetch = jest.fn()
// Remove conflicting MockRequest class
```

---

## ğŸ“ Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story criada baseada em anÃ¡lise crÃ­tica de correÃ§Ã£o de curso | Bob ğŸ“ |

---

## ğŸš¨ Critical Context

**This story addresses CRITICAL BLOCKERS for production deployment:**

1. **Structural Conflicts**: Duplicate UI components create unpredictable import conflicts
2. **Build Safety**: Current config masks critical errors that could break in production  
3. **File Organization**: Poor structure makes maintenance difficult and error-prone
4. **Test Infrastructure**: Broken testing prevents confident deployment

**Business Impact:** Without this story, the entire project remains **BLOCKED from safe production deployment** despite functional completeness.

**This is a FOUNDATIONAL story that must be completed before any new features or final deployment.**
