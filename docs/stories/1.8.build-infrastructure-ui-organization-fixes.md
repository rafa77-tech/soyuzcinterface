# Story 1.8: Build Infrastructure and UI Organization Fixes

**Criado em:** 27 de Janeiro de 2025  
**Product Owner:** Sarah 📝  
**Baseado em:** Análise de Correção de Curso QA Stories 1.6-1.7  
**Prioridade:** P0 - BLOQUEADOR DE PRODUÇÃO CRÍTICO  

---

## 📊 Status

**Status Atual:** Aproved  
**Epic:** 1.0 - Authentication and Persistence Foundation  
**Estimativa:** 16-23 horas de desenvolvimento (Sprint Emergencial)  
**Assignee:** TBD  

---

## 📖 Story

**As a** desenvolvedor e Product Owner,  
**I want** consolidar a infraestrutura de build e organizar componentes UI duplicados,  
**so that** possamos ter um sistema estruturalmente sólido, sem conflitos de build, e preparado para deploy seguro em produção.

---

## ✅ Acceptance Criteria

### Structural Requirements

**AC 1: Consolidação de Componentes UI**
- Eliminar duplicação total entre `/ui/` e `/components/ui/`
- Migrar todos imports para usar APENAS `@/components/ui`
- Validar que todos os 47+ arquivos usam imports corretos
- Remover diretório `/ui/` legado completamente

**AC 2: Reorganização de Arquivos da Raiz**
- Mover todos `*.tsx` da raiz para `/components/`
- Mover todos `use-*.ts` da raiz para `/hooks/`
- Mover `utils.ts` da raiz para `/lib/`
- Atualizar todos imports afetados pelos movimentos

**AC 3: Correção de Configuração de Build**
- Ativar validação TypeScript no build (`ignoreBuildErrors: false`)
- Ativar validação ESLint no build (`ignoreDuringBuilds: false`)
- Corrigir todos erros TypeScript/ESLint expostos
- Build deve passar sem warnings críticos

### Quality Requirements

**AC 4: Infraestrutura de Testes Corrigida**
- Corrigir mocking problemático do NextRequest
- Implementar fetch mocking adequado para APIs
- Resolver problemas de setup de DOM identificados no QA
- Atingir 80% cobertura mínima nos componentes críticos

**AC 5: Sistema Existente Intacto**
- Funcionalidade de avaliação continua operacional
- Design system mantido consistente
- Performance sem degradação
- Navegação e UX preservadas

### Technical Requirements

**AC 6: Quality Gates Implementados**
- Pre-commit hooks para validação
- Coverage gates no CI/CD pipeline
- Lint-staged para verificação automática
- Build pipeline robusto sem bypass de erros

---

## 📋 Tasks / Subtasks

### 🔴 Priority 1: Consolidação UI (AC 1)

- [ ] **Task 1: Análise e Mapeamento de Duplicações** (AC 1)
  - [ ] Executar audit completo de imports `@/ui` vs `@/components/ui`
  - [ ] Mapear todos os arquivos afetados pelos imports duplicados
  - [ ] Identificar diferenças entre versões duplicadas de componentes
  - [ ] Criar plano de migração segura

- [ ] **Task 2: Migração Segura de Imports** (AC 1)
  - [ ] Atualizar imports em `components/assessment/assessment-history.tsx`
  - [ ] Atualizar imports em `components/assessment/assessment-detail-view.tsx`
  - [ ] Atualizar imports em `components/completion-screen.tsx`
  - [ ] Atualizar imports em `components/auth-screen.tsx`
  - [ ] Atualizar imports em `components/assessment/results-viewer.tsx`
  - [ ] Atualizar imports em `components/soft-skills-screen.tsx`
  - [ ] Atualizar imports em `components/sjt-screen.tsx`
  - [ ] Atualizar imports em `components/assessment/resume-assessment-modal.tsx`
  - [ ] Atualizar imports em `components/mini-disc-screen.tsx`
  - [ ] Validar build após cada bloco de mudanças

- [ ] **Task 3: Remoção do Diretório Legado** (AC 1)
  - [ ] Backup do diretório `/ui/` para segurança
  - [ ] Validar que todos imports foram migrados
  - [ ] Remover diretório `/ui/` completamente
  - [ ] Testar build completo sem erros

### 🟡 Priority 2: Reorganização de Arquivos (AC 2)

- [ ] **Task 4: Movimentação de Screens para Components** (AC 2)
  - [ ] Mover `auth-screen.tsx` para `components/auth-screen.tsx`
  - [ ] Mover `completion-screen.tsx` para `components/completion-screen.tsx`
  - [ ] Mover `mini-disc-screen.tsx` para `components/mini-disc-screen.tsx`
  - [ ] Mover `sjt-screen.tsx` para `components/sjt-screen.tsx`
  - [ ] Mover `soft-skills-screen.tsx` para `components/soft-skills-screen.tsx`
  - [ ] Mover demais arquivos `*-screen.tsx` para `components/`
  - [ ] Atualizar imports em `app/page.tsx` e outros arquivos afetados

- [ ] **Task 5: Movimentação de Hooks e Utils** (AC 2)
  - [ ] Mover `use-mobile.ts` para `hooks/use-mobile.ts`
  - [ ] Mover `use-toast.ts` para `hooks/use-toast.ts`
  - [ ] Mover `utils.ts` para `lib/utils.ts` (consolidar com existente)
  - [ ] Atualizar todos imports afetados
  - [ ] Resolver conflitos de naming se existirem

### 🟠 Priority 3: Correção de Build (AC 3)

- [ ] **Task 6: Ativação de Validações** (AC 3)
  - [ ] Modificar `next.config.mjs` para ativar validações
  - [ ] Executar build e documentar todos erros expostos
  - [ ] Corrigir erros TypeScript identificados
  - [ ] Corrigir warnings ESLint críticos
  - [ ] Validar build limpo sem bypass

### 🟢 Priority 4: Correção de Testes (AC 4)

- [ ] **Task 7: Infraestrutura de Testes** (AC 4)
  - [ ] Corrigir setup de mock do NextRequest no `jest.setup.js`
  - [ ] Implementar fetch mocking adequado para testes de API
  - [ ] Resolver problemas de DOM rendering nos testes
  - [ ] Estabilizar testes instáveis identificados no QA Report

- [ ] **Task 8: Atingir Coverage Mínimo** (AC 4)
  - [ ] Executar coverage report atual
  - [ ] Identificar gaps críticos abaixo de 80%
  - [ ] Implementar testes específicos para gaps identificados
  - [ ] Validar 80%+ coverage nos componentes críticos

### 🟦 Priority 5: Quality Gates (AC 6)

- [ ] **Task 9: Implementação de Quality Gates** (AC 6)
  - [ ] Configurar pre-commit hooks com husky
  - [ ] Implementar lint-staged para validação automática
  - [ ] Configurar coverage gates no package.json
  - [ ] Testar pipeline completo de QA

---

## 🛠️ Dev Notes

### Previous Story Insights
[Source: docs/qa-report-story-1.6-2025-01-27.md, docs/stories/1.7.testing-implementation-suite.md]

**From QA Report - Story 1.7 Critical Issues:**
- ❌ **NextRequest Mocking**: jest.setup.js tem classe MockRequest que conflita com NextRequest do Next.js
- ❌ **Hook Implementation**: useAssessmentHistory não implementa corretamente filtros em query params  
- ❌ **Component State**: AssessmentHistory não limpa estado de erro adequadamente
- ❌ **API Integration**: Testes de API não executam pela configuração incorreta de mocks
- ❌ **Test Coverage**: Muito abaixo dos 80% requeridos (atual ~47% nos componentes críticos)

**Critical Structural Problems Identified:**
- 🚨 **UI Components DUPLICATED**: Duas estruturas completas (`/ui/` e `/components/ui/`)
- 🚨 **Build Config Masking Errors**: `ignoreBuildErrors: true` e `ignoreDuringBuilds: true`
- 🚨 **File Organization**: 10+ arquivos importantes na raiz do projeto

### Technical Context from Architecture
[Source: docs/architecture.md#component-architecture, docs/coding-standards.md]

**Project Structure Standards:**
```
/
├── app/                    # Next.js App Router
├── components/            # React Components
│   ├── __tests__/         # Component tests
│   ├── providers/         # Context Providers  
│   ├── auth/             # Auth components
│   └── ui/               # UI Components (shadcn/ui) - ÚNICO
├── hooks/                # Custom React Hooks
├── lib/                  # Libraries and utilities
│   ├── supabase/         # Supabase config
│   └── utils.ts          # Utility functions - ÚNICO
```

**File Naming Conventions:**
- **Components**: `kebab-case.tsx` (ex: `auth-screen.tsx`)
- **Hooks**: `use-nome-do-hook.ts` (ex: `use-mobile.ts`)
- **Utils**: `kebab-case.ts` (ex: `utils.ts`)

**Build Configuration Standards:**
```javascript
// next.config.mjs - REQUIRED SETTINGS:
eslint: {
  ignoreDuringBuilds: false,  // ✅ ENABLE VALIDATION
},
typescript: {
  ignoreBuildErrors: false,   // ✅ ENABLE VALIDATION
}
```

### Component Location Mapping
[Source: Project file structure analysis]

**Files to Move - Current Location → Target Location:**
```
📁 ROOT → components/:
├── auth-screen.tsx → components/auth-screen.tsx
├── completion-screen.tsx → components/completion-screen.tsx
├── mini-disc-screen.tsx → components/mini-disc-screen.tsx
├── sjt-screen.tsx → components/sjt-screen.tsx
├── soft-skills-screen.tsx → components/soft-skills-screen.tsx
├── detailed-report-screen.tsx → components/detailed-report-screen.tsx
├── final-report-screen.tsx → components/final-report-screen.tsx
├── result-screen.tsx → components/result-screen.tsx
├── assessment-screen.tsx → components/assessment-screen.tsx
├── theme-provider.tsx → components/theme-provider.tsx
└── ai-chat-widget.tsx → components/ai-chat-widget.tsx

📁 ROOT → hooks/:
├── use-mobile.ts → hooks/use-mobile.ts
└── use-toast.ts → hooks/use-toast.ts

📁 ROOT → lib/:
└── utils.ts → lib/utils.ts (merge with existing)
```

**UI Duplicates to Remove:**
```
📁 /ui/ (REMOVE ENTIRE DIRECTORY):
├── accordion.tsx          # DUPLICATE of components/ui/accordion.tsx
├── alert-dialog.tsx       # DUPLICATE of components/ui/alert-dialog.tsx
├── button.tsx             # DUPLICATE of components/ui/button.tsx
├── card.tsx               # DUPLICATE of components/ui/card.tsx
├── input.tsx              # DUPLICATE of components/ui/input.tsx
└── [... 40+ other duplicated components]
```

### Testing Infrastructure Context
[Source: jest.config.js, docs/stories/1.7.testing-implementation-suite.md]

**Current Testing Setup:**
- Framework: Jest + @testing-library/react + @testing-library/jest-dom
- Config: jest.config.js with 85% coverage thresholds
- Pattern: Tests in `__tests__/` directories

**Issues to Fix:**
```javascript
// jest.setup.js - PROBLEMA CRÍTICO:
class MockRequest {
  // Conflita com NextRequest do Next.js
}

// SOLUÇÃO NECESSÁRIA:
// Implementar mocking adequado do fetch API
global.fetch = jest.fn()
```

**Coverage Targets:**
- Global: 85% (branches, functions, lines, statements)
- assessment-service.ts: 90%
- use-assessment-autosave.ts: 85%

### Testing

**Test File Locations:**
- Component tests: `components/**/__tests__/[component-name].test.tsx`
- Hook tests: `hooks/__tests__/[hook-name].test.ts`
- API tests: `app/api/**/__tests__/route.test.ts`

**Testing Frameworks and Patterns:**
- Use Jest + @testing-library/react for components
- Use @testing-library/jest-dom for DOM assertions
- Mock API calls using Jest mocks
- Follow existing patterns in codebase for consistency

**Specific Testing Requirements:**
- 80% minimum code coverage (architectural standard)
- Test all user interactions (clicks, input, navigation)
- Test loading states, error states, and empty states
- Test file organization after moves (imports work correctly)
- Mock external dependencies (APIs, file operations)

**Mock Strategies:**
```typescript
// File Import Testing Pattern
// After moving files, test imports work:
import { Button } from '@/components/ui/button'  // Should work
import AuthScreen from '@/components/auth-screen'  // Should work after move

// API Mocking Pattern - FIXED
global.fetch = jest.fn()
// Remove conflicting MockRequest class
```

---

## 📝 Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story criada baseada em análise crítica de correção de curso | Bob 📝 |

---

## 🚨 Critical Context

**This story addresses CRITICAL BLOCKERS for production deployment:**

1. **Structural Conflicts**: Duplicate UI components create unpredictable import conflicts
2. **Build Safety**: Current config masks critical errors that could break in production  
3. **File Organization**: Poor structure makes maintenance difficult and error-prone
4. **Test Infrastructure**: Broken testing prevents confident deployment

**Business Impact:** Without this story, the entire project remains **BLOCKED from safe production deployment** despite functional completeness.

**This is a FOUNDATIONAL story that must be completed before any new features or final deployment.**
