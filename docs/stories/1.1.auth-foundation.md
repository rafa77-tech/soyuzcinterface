# Story 1.1: Setup Authentication Foundation

## Status
Approved for Developing

## Story
**As a** médico usuário,
**I want** ter acesso a um sistema de autenticação seguro,
**so that** posso criar conta, fazer login e ter meus dados protegidos durante o uso da plataforma.

## Acceptance Criteria
1. Supabase deve estar configurado e integrado ao projeto Next.js existente
2. AuthenticationProvider deve gerenciar estado global de autenticação
3. Usuário deve poder se cadastrar com email, senha e dados profissionais
4. Usuário deve poder fazer login com credenciais válidas
5. Sistema deve validar sessões e manter estado de autenticação
6. Componentes existentes devem continuar funcionando sem alterações
7. Tema dark/light existente deve permanecer operacional

## Tasks / Subtasks
- [ ] Configurar Supabase integration (AC: 1)
  - [ ] Instalar Supabase JS SDK ^2.39.0 e Auth Helpers ^0.4.0
  - [ ] Criar lib/supabase/client.ts para browser client
  - [ ] Criar lib/supabase/server.ts para API routes
  - [ ] Definir types em lib/supabase/types.ts
  - [ ] Configurar environment variables (NEXT_PUBLIC_SUPABASE_URL, SUPABASE_ANON_KEY)
- [ ] Implementar AuthenticationProvider (AC: 2, 5)
  - [ ] Criar components/providers/auth-provider.tsx 
  - [ ] Implementar useAuth() hook com signIn, signUp, signOut
  - [ ] Integrar AuthProvider no app/layout.tsx preservando ThemeProvider
  - [ ] Gerenciar estado de sessão e user profile
- [ ] Setup inicial de database schema (AC: 1)
  - [ ] Criar tabela profiles com campos: id, name, email, phone, crm, specialty, avatar_url
  - [ ] Configurar Row Level Security (RLS) policies
  - [ ] Setup de indexes necessários (profiles_crm_idx)
- [ ] Criar componente de registro/login (AC: 3, 4)
  - [ ] Refatorar auth-screen.tsx para usar Supabase Auth
  - [ ] Implementar validação de CRM e dados médicos
  - [ ] Adicionar handling de errors de autenticação
  - [ ] Preservar design system Radix UI + Tailwind existente
- [ ] Implementar testes básicos (AC: 6, 7)
  - [ ] Unit tests para AuthProvider
  - [ ] Integration tests para fluxo de signup/signin
  - [ ] Verificação de regressão para theme switching
  - [ ] Verificação de compatibilidade com componentes existentes

## Dev Notes

### Previous Story Insights
Esta é a primeira story do projeto - estabelece fundação crítica para todas as funcionalidades futuras.

### Technical Context from Architecture
[Source: docs/architecture.md#enhancement-scope-and-integration-strategy]

**Integration Approach:** Integração incremental preservando componentes de UI existentes, adicionando layer de persistência através de Supabase SDK

**Existing System Constraints:**
- Preservar componentes React existentes (MiniDiscScreen, SoftSkillsScreen, SJTScreen, CompletionScreen)
- Manter design system Tailwind CSS 4.1.9 + Radix UI atual  
- Integrar com estrutura Next.js 15.2.4 App Router existente
- State management centralizado em app/page.tsx precisa ser preservado durante transição

[Source: docs/architecture.md#component-architecture]

### Key Components to Implement

**AuthenticationProvider:**
- Responsibility: Gerenciar estado global de autenticação e sessão do usuário
- Integration: Wrapper de alto nível no layout.tsx, fornece contexto para todos componentes
- Key Interfaces: useAuth() hook, signIn(email, password), signUp(userData), signOut()
- Dependencies: Integra com app/layout.tsx como provider, usado por AuthScreen

### Data Models
[Source: docs/architecture.md#data-models-and-schema-changes]

**Profile Model:** 
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  crm TEXT NOT NULL,
  specialty TEXT NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### File Locations
[Source: docs/architecture.md#new-file-organization]

**New files to create:**
- `lib/supabase/client.ts` - Browser Supabase client
- `lib/supabase/server.ts` - Server Supabase client for API routes  
- `lib/supabase/types.ts` - TypeScript definitions
- `components/providers/auth-provider.tsx` - Authentication context provider

**Files to modify:**
- `app/layout.tsx` - Adicionar AuthProvider preservando ThemeProvider
- `components/auth-screen.tsx` - Refatorar para Supabase Auth mantendo interface atual

### Technical Constraints
[Source: docs/architecture.md#coding-standards-and-conventions]

- **Supabase Client Usage:** Sempre usar server client para API routes, browser client apenas em componentes
- **Error Handling:** Padrão try/catch com logging estruturado para Supabase operations
- **Type Safety:** Definir interfaces TypeScript para todos os modelos de dados
- **Authentication Flow:** Sempre verificar sessão em API routes antes de operações de dados

### Security Requirements  
[Source: docs/architecture.md#security-integration]

- JWT token validation em todas as API routes
- Row Level Security policies no Supabase para isolamento de dados por usuário
- Input validation com Zod schemas
- Secure cookie configuration para sessões

## Testing

### Testing Standards
[Source: docs/architecture.md#testing-strategy]

**Framework:** Jest + React Testing Library (padrão Next.js)
**Location:** __tests__ folders co-localizados com components
**Coverage Target:** 80% para AuthProvider, componentes críticos de auth

**Required Tests:**
- Unit tests para AuthProvider context e hooks
- Integration tests para fluxos completos de auth (login/logout)  
- Regression tests para garantir compatibilidade com sistema existente
- Verification que tema dark/light continua funcionando
- Verification que componentes de avaliação continuam operacionais

**Test Commands:** Setup inicial de Jest config necessário para projeto