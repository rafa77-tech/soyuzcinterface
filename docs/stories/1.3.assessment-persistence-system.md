# Story 1.3: Assessment Persistence System

## Status
Draft

## Story
**As a** médico usuário autenticado,
**I want** que o sistema salve automaticamente meu progresso durante as avaliações comportamentais e persista os resultados completos,
**so that** posso retomar avaliações interrompidas, acessar histórico de resultados e ter garantia de que meus dados não serão perdidos.

## Acceptance Criteria
1. Sistema deve salvar automaticamente o progresso durante cada etapa da avaliação (DISC, Soft Skills, SJT)
2. Usuário pode retomar avaliação incompleta de onde parou
3. Resultados completos devem ser persistidos no banco de dados ao finalizar
4. Sistema deve vincular avaliações ao usuário autenticado (user_id)
5. Interface deve mostrar feedback visual de "salvando..." durante operações de persistência
6. Sistema deve criar histórico de todas as avaliações realizadas pelo usuário
7. Dados devem incluir timestamps de início e conclusão das avaliações
8. Sistema deve suportar diferentes tipos de avaliação (complete, disc, soft_skills, sjt)
9. Resultados devem preservar estrutura JSON exata dos cálculos atuais
10. Sistema deve implementar recuperação de falhas (retry logic) para operações de banco

## Tasks / Subtasks
- [x] Implementar AssessmentPersistenceService (AC: 1, 2, 3, 4, 10)
  - [x] Criar lib/services/assessment-service.ts com CRUD operations
  - [x] Implementar saveAssessment() com auto-save capability
  - [x] Implementar getAssessmentHistory() para listar avaliações do usuário
  - [x] Implementar resumeAssessment() para continuar avaliação incompleta
  - [x] Adicionar retry logic com exponential backoff para operações de BD
- [x] Criar API endpoints para assessment management (AC: 3, 4, 6, 7, 8)
  - [x] Implementar POST /api/assessment para criar/atualizar avaliação
  - [x] Implementar GET /api/assessments para listar histórico do usuário
  - [x] Implementar GET /api/assessment/:id para recuperar avaliação específica
  - [x] Adicionar middleware de autenticação JWT em todas as rotas
  - [x] Implementar validação de dados com Zod schemas
- [ ] Integrar auto-save nos componentes de avaliação existentes (AC: 1, 5, 9)
  - [x] Modificar MiniDiscScreen para salvar progresso automaticamente
  - [ ] Modificar SoftSkillsScreen para salvar progresso automaticamente  
  - [ ] Modificar SJTScreen para salvar progresso automaticamente
  - [x] Adicionar loading states e feedback visual "salvando..."
  - [x] Preservar estrutura exata dos resultados JSON atuais
- [x] Implementar funcionalidade de resumir avaliação (AC: 2)
  - [x] Detectar avaliações incompletas no login
  - [x] Exibir modal/opção para continuar avaliação pendente
  - [x] Restaurar estado dos componentes com dados salvos
  - [x] Implementar navegação direta para etapa interrompida
- [ ] Criar sistema de histórico de avaliações (AC: 6, 7, 8)
  - [ ] Implementar tela/seção para listar avaliações anteriores
  - [ ] Exibir informações de data, tipo e status das avaliações
  - [ ] Permitir visualização de resultados de avaliações concluídas
  - [ ] Implementar filtros por tipo e data das avaliações
- [ ] Implementar testes para assessment persistence (AC: 1-10)
  - [ ] Unit tests para AssessmentPersistenceService
  - [ ] Integration tests para API endpoints /api/assessment
  - [ ] Component tests para auto-save functionality
  - [ ] E2E tests para fluxo completo de salvar e retomar avaliação
  - [ ] Tests para retry logic e error handling

## Dev Notes

### Previous Story Insights
Stories 1.1 e 1.2 estabeleceram AuthenticationProvider e UserProfileManager com Supabase integration. Esta story constrói sobre essa infraestrutura, focando na persistência dos dados de avaliação. O sistema de autenticação JWT e as APIs já estão funcionais, permitindo focus total na persistência de assessments.

### Technical Context from Architecture

#### Data Models
[Source: docs/architecture.md#data-models-and-schema-changes]

**Assessment Model Schema:**
```sql
CREATE TABLE assessments (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  type TEXT NOT NULL, -- 'complete', 'disc', 'soft_skills', 'sjt'
  status TEXT DEFAULT 'in_progress', -- 'in_progress', 'completed'
  disc_results JSONB,
  soft_skills_results JSONB,
  sjt_results JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);
```

**Key Attributes:**
- `id: UUID` - Chave primária gerada automaticamente
- `user_id: UUID NOT NULL` - Referência ao usuário autenticado
- `type: TEXT NOT NULL` - Tipo de avaliação ('complete', 'disc', 'soft_skills', 'sjt')
- `status: TEXT DEFAULT 'in_progress'` - Status da avaliação
- `disc_results: JSONB` - Resultados DISC preservando estrutura atual {D, I, S, C}
- `soft_skills_results: JSONB` - Resultados soft skills {comunicacao, lideranca, etc}
- `sjt_results: JSONB` - Resultados SJT como array de scores
- `created_at: TIMESTAMPTZ` - Início da avaliação
- `completed_at: TIMESTAMPTZ` - Conclusão da avaliação

#### API Specifications
[Source: docs/architecture.md#api-design-and-integration]

**POST /api/assessment endpoint:**
- Purpose: Criar nova avaliação ou salvar progresso de avaliação existente
- Integration: Usado pelo AssessmentPersistenceService para auto-save
- Request Format:
```json
{
  "type": "complete",
  "status": "in_progress",
  "disc_results": { "D": 25, "I": 15, "S": 20, "C": 10 },
  "soft_skills_results": { "comunicacao": 85, "lideranca": 70 },
  "sjt_results": [1, 3, 2, 4, 1]
}
```
- Response Format:
```json
{
  "id": "uuid-assessment-id",
  "status": "success",
  "message": "Assessment saved successfully"
}
```

**GET /api/assessments endpoint:**
- Purpose: Listar todas as avaliações do usuário autenticado com paginação
- Integration: Usado pelo dashboard/histórico para exibir lista
- Response Format:
```json
{
  "assessments": [
    {
      "id": "uuid",
      "type": "complete",
      "status": "completed",
      "created_at": "2025-08-07T10:00:00Z",
      "completed_at": "2025-08-07T10:45:00Z"
    }
  ],
  "pagination": { "total": 10, "page": 1, "limit": 20 }
}
```

**GET /api/assessment/:id endpoint:**
- Purpose: Recuperar avaliação específica com todos os resultados detalhados
- Integration: Usado para visualização de resultados históricos e resumir avaliação
- Response Format:
```json
{
  "id": "uuid",
  "type": "complete", 
  "status": "completed",
  "disc_results": { "D": 25, "I": 15, "S": 20, "C": 10 },
  "soft_skills_results": { "comunicacao": 85, "lideranca": 70 },
  "sjt_results": [1, 3, 2, 4, 1],
  "created_at": "2025-08-07T10:00:00Z",
  "completed_at": "2025-08-07T10:45:00Z"
}
```

#### Component Integration Strategy
[Source: docs/architecture.md#component-architecture]

**AssessmentPersistenceService:**
- Responsibility: Service layer para salvar e recuperar dados de avaliação do backend
- Integration Points: Chamado pelos componentes de tela existentes para auto-save e recuperação de dados
- Key Interfaces:
  - `saveAssessment(assessmentData)` para persistir progresso
  - `getAssessmentHistory()` para carregar histórico
  - `updateAssessmentResults(id, results)` para atualizar resultados
  - `resumeAssessment()` para continuar avaliação incompleta
- Dependencies: Usa AuthenticationProvider para user context, integra com componentes existentes

#### File Locations
[Source: docs/architecture.md#new-file-organization]

**New files to create:**
- `lib/services/assessment-service.ts` - Assessment persistence service layer
- `app/api/assessment/route.ts` - Assessment CRUD API endpoint  
- `app/api/assessments/route.ts` - List assessments API endpoint
- `app/api/assessment/[id]/route.ts` - Individual assessment API endpoint
- `components/assessment/assessment-history.tsx` - Assessment history component
- `components/assessment/resume-assessment-modal.tsx` - Resume assessment modal

**Files to enhance:**
- `components/mini-disc-screen.tsx` - Add auto-save functionality
- `components/soft-skills-screen.tsx` - Add auto-save functionality
- `components/sjt-screen.tsx` - Add auto-save functionality
- `app/page.tsx` - Add resume assessment detection and modal

#### Technical Constraints
[Source: docs/architecture.md#coding-standards-and-conventions]

- **Supabase Client Usage:** Server client para API routes, browser client para components only
- **Error Handling:** try/catch patterns com structured logging para Supabase operations
- **Type Safety:** TypeScript interfaces para todos os modelos de assessment
- **Authentication Flow:** JWT session verification obrigatório para todas as operações de assessment
- **File Organization:** Seguir app/api/ structure para RESTful endpoints
- **JSON Structure Preservation:** Manter estrutura exata dos resultados existentes para compatibilidade

#### Integration Requirements
[Source: docs/architecture.md#enhancement-scope-and-integration-strategy]

- **Existing Component Integration:** Manter compatibilidade com interfaces dos componentes MiniDiscScreen, SoftSkillsScreen, SJTScreen
- **State Management:** Integrar com state management existente em app/page.tsx sem quebrar fluxo atual
- **UI Consistency:** Preservar design system Radix UI + Tailwind CSS com loading states consistentes
- **Performance:** Implementar debounce/throttle para auto-save, evitar calls excessivas à API

#### Auto-Save Implementation Strategy
[Source: docs/architecture.md#component-architecture]

**Integration com Componentes Existentes:**
- Usar hooks personalizados para auto-save (useAssessmentAutoSave)
- Implementar debouncing para evitar calls excessivas (500ms delay)
- Preservar estrutura de props/callbacks existentes nos componentes
- Adicionar loading states visuais discretos ("salvando..." indicator)
- Manter fallback para funcionamento offline (localStorage backup)

#### Security Requirements
[Source: docs/architecture.md#security-integration]

- **Authentication:** JWT token validation para todas as assessment API endpoints
- **Authorization:** Row Level Security policies garantindo que usuários só acessem suas próprias avaliações
- **Data Validation:** Zod schemas para validação de input em client e server
- **Rate Limiting:** Implementar rate limiting para endpoints de auto-save (prevent spam)

## Testing

### Testing Standards
[Source: docs/architecture.md#testing-strategy]

**Framework:** Jest + React Testing Library (padrão Next.js)
**Location:** __tests__ folders co-localizados com components e services
**Coverage Target:** 85% para AssessmentPersistenceService, assessment API routes

**Required Tests:**
- Unit tests para AssessmentPersistenceService com mock de Supabase client
- Integration tests para API endpoints POST/GET /api/assessment, /api/assessments
- Component tests para auto-save functionality nos assessment components
- E2E tests para fluxo completo: salvar progresso → interromper → retomar → completar
- Error handling tests para network failures e retry logic
- Performance tests para auto-save debouncing

**Mocking Strategy:**
- Mock Supabase client para unit tests
- Mock AuthenticationProvider context para component tests
- Use MSW (Mock Service Worker) para integration tests de API

**Test Commands:** 
```bash
npm run test -- --coverage          # Run tests with coverage
npm run test:watch                   # Watch mode para desenvolvimento  
npm run test -- assessment          # Run apenas testes de assessment
```

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (James - Full Stack Developer)

### File List
**New files created:**
- `lib/services/assessment-service.ts` - Assessment persistence service with CRUD operations and retry logic
- `app/api/assessment/route.ts` - Main assessment API endpoint (POST/GET)
- `app/api/assessments/route.ts` - Assessment history listing endpoint
- `app/api/assessment/[id]/route.ts` - Individual assessment management endpoint
- `components/assessment/resume-assessment-modal.tsx` - Modal for resuming incomplete assessments
- `hooks/use-assessment-autosave.ts` - Auto-save hook (partial implementation - has linter issues)

**Files modified:**
- `lib/supabase/types.ts` - Added Assessment table types and related interfaces
- `components/mini-disc-screen.tsx` - Integrated auto-save functionality with visual feedback
- `app/page.tsx` - Added incomplete assessment detection and resume functionality

### Completion Notes
- ✅ **AssessmentPersistenceService**: Fully implemented with retry logic, auto-save capability, and comprehensive CRUD operations
- ✅ **API Endpoints**: All 3 endpoints created with JWT authentication, Zod validation, and proper error handling
- ✅ **Auto-save Integration**: Successfully integrated in MiniDiscScreen with visual feedback states
- ✅ **Resume Functionality**: Complete implementation with modal and state restoration
- ⚠️ **Auto-save Hook**: Created but has linter issues - used direct implementation in components instead
- 🚧 **Missing**: SoftSkillsScreen and SJTScreen auto-save integration, history system, comprehensive testing

### Debug Log References
- Line 41 in hooks/use-assessment-autosave.ts: useAuth() argument error - bypassed by implementing direct auto-save in components
- Fixed WelcomeScreen interface mismatch (onNext vs onStart)
- Resolved type casting issues for Json types in AssessmentPersistenceService

## QA Results

### Review Date: 2025-08-08

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**⚠️ INCOMPLETE IMPLEMENTATION REVIEW**

This story was reviewed in Draft status rather than Review status. The implementation is approximately 60% complete as indicated by the Epic status, with significant functionality still pending implementation.

**Completed Components (High Quality):**
- ✅ **AssessmentPersistenceService**: Well-architected service layer with comprehensive CRUD operations
- ✅ **API Infrastructure**: Three endpoints properly implemented with JWT auth and Zod validation
- ✅ **MiniDiscScreen Integration**: Auto-save successfully integrated with visual feedback
- ✅ **Resume Functionality**: Complete modal and state restoration implementation

**Quality Concerns Identified:**
- 🔧 **useAssessmentAutoSave Hook**: Has linter issues (useAuth() argument error)
- 🚧 **Missing Integration**: SoftSkillsScreen and SJTScreen auto-save not implemented
- 🚨 **No Testing**: Critical blocker - zero test implementation despite comprehensive testing requirements

### Refactoring Performed

None - Story not ready for refactoring due to incomplete implementation.

### Compliance Check

- Coding Standards: ⚠️ Partially - linter issues in hooks/use-assessment-autosave.ts
- Project Structure: ✓ File locations and organization follow Next.js App Router patterns
- Testing Strategy: ✗ **CRITICAL** - No tests implemented, 85% coverage target not met
- All ACs Met: ✗ ACs 1, 5, 6, 7, 8, 9 partially implemented

### Improvements Checklist

**Before Story Can Be Approved:**

- [ ] **CRITICAL**: Implement comprehensive testing suite (AC validation blocker)
  - [ ] Unit tests for AssessmentPersistenceService  
  - [ ] Integration tests for API endpoints
  - [ ] Component tests for auto-save functionality
  - [ ] E2E tests for save/resume flow
  - [ ] Error handling and retry logic tests

- [ ] **CRITICAL**: Complete auto-save integration (AC 1, 5, 9 blockers)
  - [ ] Implement SoftSkillsScreen auto-save
  - [ ] Implement SJTScreen auto-save  
  - [ ] Fix useAssessmentAutoSave hook linter issues

- [ ] **CRITICAL**: Implement history system (AC 6, 7, 8 blockers)
  - [ ] Create assessment history dashboard
  - [ ] Implement filtering and pagination
  - [ ] Add result visualization functionality

- [ ] **RECOMMENDED**: Technical debt resolution
  - [ ] Resolve useAuth() argument error in auto-save hook
  - [ ] Add error boundaries for assessment components
  - [ ] Implement offline fallback strategy

### Security Review

✓ **Authentication**: JWT validation properly implemented in API endpoints
✓ **Authorization**: User-scoped data access via Supabase RLS (assumed from architecture)
✓ **Data Validation**: Zod schemas implemented for input validation
⚠️ **Rate Limiting**: Mentioned in requirements but implementation not verified

### Performance Considerations

✓ **Debouncing**: Strategy defined (500ms delay) but needs verification in SoftSkills/SJT integration
⚠️ **Auto-save Frequency**: Not tested under load conditions
⚠️ **Database Query Optimization**: Needs review when history system is implemented

### Final Status

**✗ Changes Required - Implementation Incomplete**

**Blocking Issues:**
1. **Testing Gap**: Zero test coverage vs 85% requirement - production deployment blocker
2. **Feature Incompleteness**: 40% of auto-save functionality missing (SoftSkills, SJT)  
3. **History System**: Entire AC requirement (6, 7, 8) not implemented

**Epic Alignment**: Review confirms Epic's 60% completion assessment is accurate.

**Recommendation**: Complete remaining implementation tasks before requesting QA review. Story should be moved to "Review" status only after all tasks marked complete and dev agent confirms full functionality.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-07 | 1.0 | Initial story creation for assessment persistence system | Bob (Scrum Master) |
| 2025-01-27 | 1.1 | Implemented core persistence infrastructure, auto-save for DISC, and resume functionality | James (Dev Agent) |
| 2025-08-08 | 1.2 | QA Review - Implementation incomplete, identified critical blockers for completion | Quinn (QA) |