# Story 1.4: Auto-save Completion

## Status
Planned

## Story
**As a** médico usuário autenticado,  
**I want** que o sistema salve automaticamente meu progresso em TODAS as etapas da avaliação (SoftSkills e SJT),  
**so that** posso ter garantia completa de que meus dados não serão perdidos em qualquer componente.

## Acceptance Criteria
1. SoftSkillsScreen implementa auto-save a cada mudança de slider
2. SJTScreen implementa auto-save a cada resposta selecionada  
3. Loading states visuais ("salvando...") consistentes entre todos os componentes
4. Error handling padronizado para falhas de auto-save
5. Debouncing de 500ms implementado para evitar calls excessivas
6. Hook useAssessmentAutoSave refatorado e utilizado em todos os componentes
7. Fallback para localStorage em caso de falhas de conectividade
8. Auto-save preserva estrutura JSON exata dos resultados existentes

## Priority
HIGH - Bloqueia Epic 2

## Dependencies
- Story 1.3: Assessment Persistence System (API infrastructure)
- AuthenticationProvider (Stories 1.1-1.2)

## Tasks / Subtasks
- [ ] Refatorar useAssessmentAutoSave hook (AC: 6)
  - [ ] Corrigir linter errors identificados em hooks/use-assessment-autosave.ts
  - [ ] Implementar debouncing de 500ms para reduzir API calls
  - [ ] Adicionar error handling com retry logic (3 tentativas)
  - [ ] Implementar fallback localStorage para offline persistence
  - [ ] Adicionar TypeScript types robustos
- [ ] Implementar auto-save no SoftSkillsScreen (AC: 1, 3, 8)
  - [ ] Integrar useAssessmentAutoSave hook no componente
  - [ ] Implementar auto-save triggered por onChange dos sliders
  - [ ] Adicionar loading state visual "salvando..." discreto
  - [ ] Preservar estrutura JSON exata dos soft_skills_results atuais
  - [ ] Implementar error handling visual para falhas de save
- [ ] Implementar auto-save no SJTScreen (AC: 2, 3, 8)
  - [ ] Integrar useAssessmentAutoSave hook no componente
  - [ ] Implementar auto-save triggered por seleção de resposta
  - [ ] Adicionar loading state visual "salvando..." discreto
  - [ ] Preservar estrutura JSON exata dos sjt_results atuais
  - [ ] Implementar error handling visual para falhas de save
- [ ] Padronizar loading states entre todos os componentes (AC: 3)
  - [ ] Criar componente SavingIndicator reutilizável
  - [ ] Aplicar design consistente em MiniDiscScreen, SoftSkillsScreen, SJTScreen
  - [ ] Implementar toast notifications para feedback de save success/error
- [ ] Implementar error handling padronizado (AC: 4, 7)
  - [ ] Criar função handleAutoSaveError centralizizada
  - [ ] Implementar fallback strategy: retry → localStorage → user notification
  - [ ] Adicionar logs estruturados para debugging de falhas
  - [ ] Criar recovery mechanism para restaurar de localStorage

## Dev Notes

### Previous Story Context
Story 1.3 estabeleceu a infraestrutura API (/api/assessment endpoints) e implementou auto-save básico no MiniDiscScreen. Esta story completa a implementação nos 2 componentes faltantes e melhora a qualidade técnica.

### Technical Foundation Available
- ✅ AssessmentPersistenceService funcional (lib/services/assessment-service.ts)
- ✅ API endpoints: POST /api/assessment, GET /api/assessments, GET /api/assessment/[id]
- ✅ Database schema: assessments table com JSONB fields
- ✅ Authentication context via AuthenticationProvider
- ⚠️ Hook useAssessmentAutoSave existe mas tem issues (linha 41)

### Component Integration Strategy

**SoftSkillsScreen Integration:**
- Target file: `components/soft-skills-screen.tsx`
- Trigger: onChange events dos sliders de soft skills
- Data structure: `{ comunicacao: number, lideranca: number, trabalho_equipe: number, etc }`
- Save frequency: Debounced 500ms após última mudança

**SJTScreen Integration:**
- Target file: `components/sjt-screen.tsx`  
- Trigger: onAnswer events das questões SJT
- Data structure: Array de scores `[1, 3, 2, 4, 1]`
- Save frequency: Imediato após cada resposta (debounced)

### Error Handling Strategy
```typescript
// Fallback hierarchy para auto-save failures:
1. Retry with exponential backoff (3x)
2. Save to localStorage as backup
3. Show user notification but continue UX
4. Restore from localStorage on next session
```

### File Locations

**Files to modify:**
- `hooks/use-assessment-autosave.ts` - Fix linter issues, add debouncing
- `components/soft-skills-screen.tsx` - Add auto-save integration
- `components/sjt-screen.tsx` - Add auto-save integration
- `components/mini-disc-screen.tsx` - Standardize with refactored hook

**New files to create:**
- `components/ui/saving-indicator.tsx` - Reusable saving state component
- `lib/utils/auto-save-fallback.ts` - localStorage fallback utilities

### Technical Constraints
- **Preserve JSON Structure:** Manter compatibilidade exata com estruturas de dados existentes
- **Performance:** Debouncing obrigatório para evitar spam de API calls
- **UX Continuity:** Auto-save deve ser invisível ao usuário (exceto loading indicator)
- **Error Recovery:** Falhas de auto-save não devem interromper fluxo de avaliação

### Integration Requirements
- **Existing State Management:** Preservar state management atual dos componentes
- **Design System:** Usar Radix UI + Tailwind CSS para loading indicators
- **Authentication:** Usar AuthenticationProvider context para user_id
- **API Integration:** Usar endpoints existentes da Story 1.3

## Testing

### Testing Strategy
**Framework:** Jest + React Testing Library  
**Coverage Target:** 85% para hook refatorado e componentes modificados  
**Location:** Co-localizado com components (`__tests__` folders)

**Required Tests:**
- Unit tests para useAssessmentAutoSave hook (debouncing, error handling)
- Component tests para SoftSkillsScreen auto-save integration
- Component tests para SJTScreen auto-save integration  
- Integration tests para fallback localStorage functionality
- Error simulation tests para network failures
- Performance tests para debouncing behavior

**Mock Strategy:**
- Mock API calls para testing error scenarios
- Mock localStorage para fallback testing
- Mock AuthenticationProvider context
- Mock timers para debouncing tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Story creation based on Correct Course Analysis - auto-save completion | Bob (Scrum Master) | 